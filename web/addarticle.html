<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>发布文章-星云号</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/nprogress.css">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/styles.css">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://static.anman.org/Trumbowyg/ui/trumbowyg.min.css" type="text/css">
    <link rel="apple-touch-icon-precomposed" href="http://static.anman.org/nphot/images/icon.png">
    <link rel="shortcut icon" href="http://static.anman.org/nphot/images/favicon.ico">
    <script src="http://static.anman.org/nphot/js/jquery-2.1.4.min.js"></script>
    <script src="http://static.anman.org/nphot/js/nprogress.js"></script>
    <script src="http://static.anman.org/nphot/js/jquery.lazyload.min.js"></script>
    <!--[if gte IE 9]>
    <script src="http://static.anman.org/nphot/js/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="http://static.anman.org/nphot/js/html5shiv.min.js" type="text/javascript"></script>
    <script src="http://static.anman.org/nphot/js/respond.min.js" type="text/javascript"></script>
    <script src="http://static.anman.org/nphot/js/selectivizr-min.js" type="text/javascript"></script>
    <![endif]-->
    <!--[if lt IE 9]>
    <script>window.location.href = 'upgrade-browser.html';</script>
    <![endif]-->

    <style type="text/css">
        body {
            word-break: break-all;
        }

        .noExtension {
            margin: auto;
            font-size: 23px;
        }
    </style>
</head>
<body class="user-select">
<header class="header">
    <nav class="navbar navbar-default" id="navbar">
        <div class="container">
            <div class="header-topbar hidden-xs link-border">
                <ul class="site-nav topmenu">
                    <!--<li><a href="users.html">作者墙</a></li>-->
                    <li><a href="rss.html" title="RSS订阅">
                        <i class="fa fa-rss">
                        </i> RSS订阅
                    </a></li>
                </ul>
                YES,WE BELIEVE
            </div>
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#header-navbar" aria-expanded="false"><span class="sr-only"></span> <span
                        class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button>
                <h1 class="logo hvr-bounce-in"><a href="http://www.nphot.com/" title="星云号"><img
                        src="http://static.anman.org/nphot/images/logo.png" alt="星云号"></a></h1>
            </div>
            <div class="collapse navbar-collapse" id="header-navbar">
                <form class="navbar-form visible-xs" action="/Search" method="post">
                    <div class="input-group">
                        <input type="text" name="keyword" class="form-control" placeholder="请输入关键字" maxlength="20"
                               autocomplete="off">
                        <span class="input-group-btn">
            <button class="btn btn-default btn-search" name="search" type="submit">搜索</button>
            </span></div>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li><a data-cont="星云号" title="星云号" href="index.html">首页</a></li>
                    <li><a data-cont="文章列表" title="文章列表" href="articles.html">文章列表</a></li>
                    <li><a data-cont="作者列表" title="作者列表" href="users.html">作者列表</a></li>
                    <li><a data-cont="作者注册" title="作者注册" href="user_reg.html">作者注册</a></li>
                    <li><a data-cont="发布文章" title="发布文章" href="addarticle.html">发布文章</a></li>
                    <li><a data-cont="Nebulas" title="Nebulas" href="https://nebulas.io">Nebulas</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<section id="noExtensions" style="margin-top:1px;padding-bottom: 0px;background-color:red; color:#fff;display: none;">
    <div class="container">
        <div class="row">
            <div class="noExtension col-md-12" id="noExtension">
                注意: 请安装谷歌浏览器扩展<a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a>
            </div>
        </div>
    </div>
</section>
<section class="container container-page">
    <div class="pageside">
        <div class="pagemenus">
            <ul class="pagemenu">
                <li><a href="index.html" title="星云号" draggable="false">星云号</a></li>
                <li><a href="users.html" title="作者墙" draggable="false">作者墙</a></li>
                <li><a href="addarticle.html" title="写文章" draggable="false">写文章</a></li>

            </ul>
        </div>
    </div>
    <div class="content">
        <header class="article-header">
            <h1 class="article-title">写文章</h1>
        </header>
        <div class="readers" id="article">
            <div class="form-horizontal">
                <div class="form-group">
                    <label for="title" class="col-sm-2 control-label">标题:</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="title" placeholder="文章题目" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="image" class="col-sm-2 control-label">插图:</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="image" placeholder="文章图片" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="summary" class="col-sm-2 control-label">摘要:</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" id="summary"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="content" class="col-sm-2 control-label">内容:</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" id="content"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="content" class="col-sm-2 control-label">推广:</label>
                    <div class="col-sm-10">
                        <table class="table table-hover">
                            <tr>
                                <td width="100px">红包个数：</td>
                                <td><input type="text" class="form-control" id="zantotals"
                                           placeholder="设置数量点赞的用户将得到NAS奖励" required></td>
                            </tr>
                            <tr>
                                <td width="100px">红包(NAS)：</td>
                                <td><input type="text" class="form-control" id="zanfee" placeholder="每次奖励的NAS" required>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10 padding-big">
                        <button type="submit" class="btn btn-primary" onclick="add()" id="add">发布</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<footer class="footer">
    <div class="container">
        <p>星云号[<a href="http://www.nphot.com">www.nphot.com</a> ]由星云链[<a href="https://nebulas.io" target="_blank"
                                                                         rel="nofollow">Nebulas</a>] 驱动.<a
                href="http://www.miitbeian.gov.cn/" target="_blank" rel="nofollow">浙ICP备14037650号</a> &nbsp; <a
                href="http://www.nphot.com/sitemap.xml" target="_blank" class="sitemap">网站地图</a></p>
    </div>
    <!--<div id="gotop"><a class="gotop"></a></div>-->
</footer>
<script src="http://static.anman.org/nphot/js/bootstrap.min.js"></script>
<script src="http://static.anman.org/static/bootstrap/js/nebulas.js"></script>
<script src="http://static.anman.org/static/bootstrap/js/bootbox.min.js"></script>
<script src="http://static.anman.org/static/bootstrap/js/nebPay.js"></script>
<script src="http://static.anman.org/Trumbowyg/trumbowyg.min.js"></script>
<script src="http://static.anman.org/Trumbowyg/langs/zh_cn.min.js"></script>
<script src="seed.js"></script>
<script src="initcall.js"></script>
<script type="text/javascript">
    if (typeof(webExtensionWallet) === "undefined") {
        $("#noExtensions").show();
    }
    var Amount = 0;

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();

    $(document).ready(function () {
        $("#content").trumbowyg({
            lang: 'zh_cn',
            btns: [
                ['formatting'],
                ['strong', 'em', 'del'],
                ['superscript', 'subscript'],
                ['link'],
                ['insertImage'],
                ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'],
                ['unorderedList', 'orderedList'],
                ['horizontalRule'],
            ]
        });


        //price
        $("#zanfee").change(function () {
            let tmp = $(this).val().replace(/[^0-9.]/g, '');
            if (!tmp) {
                tmp = 0;
            }
            $(this).val(parseFloat(tmp).toFixed(8));
        }).bind("paste", function () {  //CTR+V事件处理
            let tmp = $(this).val().replace(/[^0-9.]/g, '');
            if (!tmp) {
                tmp = 0;
            }
            $(this).val(parseFloat(tmp).toFixed(8));
        }).css("ime-mode", "disabled"); //CSS设置输入法不可用

        //price
        $("#zantotals").change(function () {
            let tmp = $(this).val().replace(/[^0-9.]/g, '');
            if (!tmp) {
                tmp = 0;
            }
            $(this).val(parseInt(tmp));
        }).bind("paste", function () {  //CTR+V事件处理
            let tmp = $(this).val().replace(/[^0-9.]/g, '');
            if (!tmp) {
                tmp = 0;
            }
            $(this).val(parseInt(tmp));
        }).css("ime-mode", "disabled"); //CSS设置输入法不可用
    });


    var add = function () {
        $("#add").attr('disabled', true);
        var tres = [];
        var title = $("#title").val();
        var image = $("#image").val();
        var summary = $("#summary").val();
        var content = $("#content").val();
        var zanfee = $("#zanfee").val();
        var zantotals = $("#zantotals").val();
        if (title === "" || content === "" || zanfee === "" || zantotals === "") {
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: "字段是必填的",
                size: "large",
                title: "Error"
            });
        } else {
            tres.push(title);
            tres.push(summary);
            tres.push(content);
            tres.push(image);
            tres.push(zanfee);
            tres.push(zantotals);
            let callArgs = JSON.stringify(tres);
            let callFunction = "addarticle";
            Amount = zanfee * zantotals;
            nebPay.call(ContractAddress, Amount, callFunction, callArgs, {
                qrcode: {
                    showQRCode: true
                },
                listener: cbPush        //设置listener, 处理交易返回信息
            });
        }
    };

    var cbPush = function (resp) {
        console.log("response of push: " + JSON.stringify(resp));
        if (resp.txhash) {
            getstatus(resp.txhash);
        } else {
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: JSON.stringify(resp),
                size: "large",
                title: "ERROR"
            });
        }
    };
    var getstatus = function (txhash) {
        let v = this;
        neb.api.getTransactionReceipt(txhash)
            .then(o => {
                console.log(JSON.stringify(o));
                this.transaction_status = o.status;
                this.red_address = o.from;
                if (o.status === 2) {
                    window.setTimeout(() => this.getstatus(txhash), 2000)
                } else if (o.status === 1) {
                    bootbox.dialog({
                        backdrop: true,
                        onEscape: true,
                        message: "发布成功",
                        size: "large",
                        title: "SUCCESS"
                    });
                    setTimeout(function () {
                        location.href = "index.html";
                    }, 2000);

                } else {
                    $("#add").attr('disabled', false);
                    bootbox.dialog({
                        backdrop: true,
                        onEscape: true,
                        message: o.execute_result,
                        size: "large",
                        title: "ERROR"
                    });
                }
            })
            .catch(function (o) {
                $("#add").attr('disabled', false);
                console.log(o)
            })
    };
</script>
</body>
</html>
