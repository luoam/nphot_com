<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>作者信息-星云号</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/nprogress.css">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/styles.css">
    <link rel="stylesheet" type="text/css" href="http://static.anman.org/nphot/css/font-awesome.min.css">
    <link rel="apple-touch-icon-precomposed" href="http://static.anman.org/nphot/images/icon.png">
    <link rel="shortcut icon" href="http://static.anman.org/nphot/images/favicon.ico">
    <script src="http://static.anman.org/nphot/js/jquery-2.1.4.min.js"></script>
    <script src="http://static.anman.org/nphot/js/nprogress.js"></script>
    <script src="http://static.anman.org/nphot/js/jquery.lazyload.min.js"></script>
    <!--[if gte IE 9]>
    <script src="http://static.anman.org/nphot/js/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="http://static.anman.org/nphot/js/html5shiv.min.js" type="text/javascript"></script>
    <script src="http://static.anman.org/nphot/js/respond.min.js" type="text/javascript"></script>
    <script src="http://static.anman.org/nphot/js/selectivizr-min.js" type="text/javascript"></script>
    <![endif]-->
    <!--[if lt IE 9]>
    <script>window.location.href = 'upgrade-browser.html';</script>
    <![endif]-->

    <style type="text/css">
        body {
            word-break: break-all;
        }

        .noExtension {
            margin: auto;
            font-size: 23px;
        }

        .panel {
            padding: 80px 20px 0px;
            min-height: 400px;
            cursor: default;
        }

        .text-center {
            margin: 0 auto;
            text-align: center;
            border-radius: 10px;
            max-width: 900px;
            -moz-box-shadow: 0px 0px 5px rgba(0, 0, 0, .3);
            -webkit-box-shadow: 0px 0px 5px rgba(0, 0, 0, .3);
            box-shadow: 0px 0px 5px rgba(0, 0, 0, .1);
        }

        .float-left {
            float: left !important;
        }

        .float-right {
            float: right !important;
        }

        img {
            border: 0;
            vertical-align: bottom;
        }

        h2 {
            padding-top: 20px;
            font-size: 20px;
        }

        .padding-big {
            padding: 20px;
        }

        .alert {
            border-radius: 5px;
            padding: 15px;
            border: solid 1px #ddd;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body class="user-select">
<header class="header">
    <nav class="navbar navbar-default" id="navbar">
        <div class="container">
            <div class="header-topbar hidden-xs link-border">
                <ul class="site-nav topmenu">
                    <!--<li><a href="users.html">作者墙</a></li>-->
                    <li><a href="rss.html" title="RSS订阅">
                        <i class="fa fa-rss">
                        </i> RSS订阅
                    </a></li>
                </ul>
                YES,WE BELIEVE
            </div>
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#header-navbar" aria-expanded="false"><span class="sr-only"></span> <span
                        class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button>
                <h1 class="logo hvr-bounce-in"><a href="http://www.nphot.com/" title="星云号"><img
                        src="http://static.anman.org/nphot/images/logo.png" alt="星云号"></a></h1>
            </div>
            <div class="collapse navbar-collapse" id="header-navbar">
                <form class="navbar-form visible-xs" action="/Search" method="post">
                    <div class="input-group">
                        <input type="text" name="keyword" class="form-control" placeholder="请输入关键字" maxlength="20"
                               autocomplete="off">
                        <span class="input-group-btn">
            <button class="btn btn-default btn-search" name="search" type="submit">搜索</button>
            </span></div>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li><a data-cont="星云号" title="星云号" href="index.html">首页</a></li>
                    <li><a data-cont="文章列表" title="文章列表" href="articles.html">文章列表</a></li>
                    <li><a data-cont="作者列表" title="作者列表" href="users.html">作者列表</a></li>
                    <li><a data-cont="作者注册" title="作者注册" href="user_reg.html">作者注册</a></li>
                    <li><a data-cont="发布文章" title="发布文章" href="addarticle.html">发布文章</a></li>
                    <li><a data-cont="Nebulas" title="Nebulas" href="https://nebulas.io">Nebulas</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<section id="noExtensions" style="margin-top:1px;padding-bottom: 0px;background-color:red; color:#fff;display: none;">
    <div class="container">
        <div class="row">
            <div class="noExtension col-md-12" id="noExtension">
                注意: 请安装谷歌浏览器扩展<a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a>
            </div>
        </div>
    </div>
</section>
<section class="container">
    <div class="panel">
        <div class="text-center">
            <header class="article-header">
                <h1 class="article-title"><stong>作者信息</stong></h1>
            </header>

            <div style="text-align: left" id="info">

            </div>
            <header class="article-header">
                <h1 class="article-title"><stong>文章信息</stong></h1>
            </header>
            <div class="relates" style="text-align: left" id="articles">


            </div>
        </div>
    </div>
</section>


<footer class="footer">
    <div class="container">
        <p>星云号[<a href="http://www.nphot.com">www.nphot.com</a> ]由星云链[<a href="https://nebulas.io" target="_blank"
                                                                         rel="nofollow">Nebulas</a>] 驱动.<a
                href="http://www.miitbeian.gov.cn/" target="_blank" rel="nofollow">浙ICP备14037650号</a> &nbsp; <a
                href="http://www.nphot.com/sitemap.xml" target="_blank" class="sitemap">网站地图</a></p>
    </div>
    <!--<div id="gotop"><a class="gotop"></a></div>-->
</footer>
<script src="http://static.anman.org/nphot/js/bootstrap.min.js"></script>
<script src="http://static.anman.org/static/bootstrap/js/bootbox.min.js"></script>
<script src="http://static.anman.org/static/bootstrap/js/nebulas.js"></script>
<script src="http://static.anman.org/static/bootstrap/js/nebPay.js"></script>
<script src="seed.js"></script>
<script src="initcall.js"></script>
<script type="text/javascript">
    if (typeof(webExtensionWallet) === "undefined") {
        $("#noExtensions").show();
    }
    var Amount = 0;

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var account;
    $(document).ready(function () {
        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "H+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        };
        $.extend({
            getUrlVars: function () {
                var vars = [], hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                }
                return vars;
            },
            getUrlVar: function (name) {
                return $.getUrlVars()[name];
            }
        });
        account = $.getUrlVar('account');

        //step1
        initCall(function (params) {
            console.log(params);
            var tmp = [];
            tmp.push(account);
            var callArgs = JSON.stringify(tmp);
            neb.api
                .call({
                    from: params.from,
                    to: params.to,
                    value: params.value,
                    nonce: params.nonce,
                    gasPrice: params.gasPrice,
                    gasLimit: params.gasLimit,
                    contract: {
                        "function": "getuserinfo",
                        "args": callArgs
                    }
                })
                .then(function (resp) {
                    console.log("callback resp: " + resp);
                    if (resp.execute_err) {
                        bootbox.dialog({
                            backdrop: true,
                            onEscape: true,
                            message: resp.execute_err,
                            size: "large",
                            title: "Error"
                        });

                    } else {
                        let result = JSON.parse(resp.result);
                        console.log(result);
                        if (result.length === 0) {
                            let str = "<li>没有作者信息q</li>";
                            $("#writers").append(str);
                        } else {
                            let nickname = result.nickname;
                            let account = result.account;
                            let review = result.review;
                            let email = result.email;
                            let timestamp = result.timestamp;
                            let str = "";
                            let review_str = "";
                            if (review) {
                                review_str = review;
                            } else {
                                review_str = "<a id=\"review\" onclick=\"review(\'" + account + "\')\" class=\"btn btn-primary\">审查</a>";
                            }
                            str = "<div class=\"padding-big\">昵称：" + nickname + "</div>" +
                                "                <div class=\"padding-big\">邮箱：" + email + "</div>" +
                                "                <div class=\"padding-big\">NAS钱包地址：" + account + "</div>" +
                                "                <div class=\"padding-big\">注册时间：" + showtime(timestamp) + "</div>" +
                                "                <div class=\"padding-big\">审核：" + review_str + "</div>"+
                                "                <div class=\"padding-big\">自我介绍：" + result.introduction + "</div>";


                            $("#info").append(str);
                        }

                    }
                })
                .catch(function (err) {
                    let str = "<li>没有作者信息</li>";
                    $("#writers").append(str);
                    console.log(JSON.stringify(err));
                });
        });

        //step2
        initCall(function (params) {
            console.log(params);
            var tmp = [];
            tmp.push(account);
            tmp.push(10);
            tmp.push(0);
            var callArgs = JSON.stringify(tmp);
            neb.api
                .call({
                    from: params.from,
                    to: params.to,
                    value: params.value,
                    nonce: params.nonce,
                    gasPrice: params.gasPrice,
                    gasLimit: params.gasLimit,
                    contract: {
                        "function": "getarticlelistbyaccount",
                        "args": callArgs
                    }
                })
                .then(function (resp) {
                    console.log("callback resp: " + resp);
                    if (resp.execute_err) {
                        bootbox.dialog({
                            backdrop: true,
                            onEscape: true,
                            message: resp.execute_err,
                            size: "large",
                            title: "Error"
                        });

                    } else {
                        let result_total = JSON.parse(resp.result);
                        let result = result_total.result;
                        console.log(result);
                        if (result.length === 0) {
                            let str = "<li>没有文章信息</li>";
                            $("#articles").append(str);
                        } else {
                            let str_article = "";
                            for (let i = 0; i <result.length ; i++) {
                                let item = result[i];
                                console.log(item);
                                str_article +="<div class=\"padding-big\"><a href=\"article.html?id="+item.id+"\">"+item.title+"</a></div>";

                            }
                            $("#articles").append(str_article);
                        }

                    }
                })
                .catch(function (err) {
                    let str = "<li>没有作者信息</li>";
                    $("#writers").append(str);
                    console.log(JSON.stringify(err));
                });
        });
    });
    var review = function (account) {
        $("#review").attr('disabled', true);
        var tres = [];
        tres.push(account);
        let callArgs = JSON.stringify(tres);
        let callFunction = "userreview";
        nebPay.call(ContractAddress, Amount, callFunction, callArgs, {
            qrcode: {
                showQRCode: true
            },
            listener: cbPush        //设置listener, 处理交易返回信息
        });
    };
    var cbPush = function (resp) {
        console.log("response of push: " + JSON.stringify(resp));
        if (resp.txhash) {
            getstatus(resp.txhash);
        } else {
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: JSON.stringify(resp),
                size: "large",
                title: "ERROR"
            });
        }
    };
    var getstatus = function (txhash) {
        let v = this;
        neb.api.getTransactionReceipt(txhash)
            .then(o => {
                console.log(JSON.stringify(o));
                this.transaction_status = o.status;
                this.red_address = o.from;
                if (o.status === 2) {
                    window.setTimeout(() => this.getstatus(txhash), 2000)
                } else if (o.status === 1) {
                    bootbox.dialog({
                        backdrop: true,
                        onEscape: true,
                        message: "审查成功",
                        size: "large",
                        title: "SUCCESS"
                    });
                    setTimeout(function () {
                        location.reload();
                    }, 2000);

                } else {
                    bootbox.dialog({
                        backdrop: true,
                        onEscape: true,
                        message: o.execute_result,
                        size: "large",
                        title: "ERROR"
                    });
                }
            })
            .catch(function (o) {
                console.log(o)
            })

    };


    function showtime(t) {
        var newDate = new Date();
        newDate.setTime(t);
        console.log(newDate.toLocaleString());
        return newDate.Format("yyyy年MM月dd日 HH:mm:ss");
    }
</script>
</body>
</html>
